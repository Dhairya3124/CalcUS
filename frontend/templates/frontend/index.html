{% extends 'frontend/base.html' %}

{% load static %}

{% block extrahead %}
	<link rel="stylesheet" href="{% static 'frontend/ChemDoodleWeb.css' %}" type="text/css">
	<script type="text/javascript" src="{% static 'frontend/ChemDoodleWeb.js' %}"></script>
	<link rel="stylesheet" href="{% static 'frontend/uis/jquery-ui-1.11.4.css' %}" type="text/css">
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<script type="text/javascript" src="{% static 'frontend/uis/ChemDoodleWeb-uis.js' %}"></script>
	<script>
		let page = {{ page }};
		$(document).ready(function(){
			refresh_list();
		});
		
		function refresh_list() {
			var sel = document.getElementById("calc_project");
			opt = sel.options[sel.selectedIndex].text;

			var sel2 = document.getElementById("calc_user");
			user = sel2.options[sel2.selectedIndex].text;

			var sel3 = document.getElementById("calc_type");
			type = sel3.options[sel3.selectedIndex].text;

			$.ajax({
				data: {
					csrfmiddlewaretoken: ('{{csrf_token}}'),
					project: opt,	
					page: page,
					user: user,
					type: type,
				},
				method: "GET",
				url: '/list/',
				success: function (data, textStatus, xhr) {
					if (xhr.status != 204) {
				    		$("#calculations_list").html(data);
					}
				},
				error: function () {
				    $("#calculations_list").html("");
					
				}
			    });

		}
		function set_page(newpage) {
			page = newpage;
			refresh_list();
		}

		function refresh_project_list() {
			var sel2 = document.getElementById("calc_user");
			user = sel2.options[sel2.selectedIndex].text;
			$.ajax({
				data: {
					csrfmiddlewaretoken: ('{{csrf_token}}'),
					user: user,
				},
				method: "POST",
				url: '/project_list/',
				success: function (data, textStatus, xhr) {
					if (xhr.status != 204) {
				    		$("#calc_project").html(data);
						refresh_list();
					}
				},
				error: function () {
				    $("#calc_project").html("");
					
				}
			    });


		}
	</script>
{% endblock %}

{% block content %}
<div class="container">
	{% if user.is_authenticated %}
		<div class="select" >
			<select name="calc_user" id="calc_user" onchange="set_page(1);refresh_project_list();">
				<option>{{ user.username }}</option>
				{% for teammate in user.profile.groups.members.all %}
					{% if teammate != user.profile %}
						<option name="{{ teammate.username }}">{{ teammate.username }}</option>
					{% endif %}
				{% endfor %}
				{% if user.profile.groups.PI != None %}
					<option name="{{ user.profile.groups.PI.username }}">{{ user.profile.groups.PI.username }}</option>
				{% endif %}
				{% for group in user.profile.researchgroup_PI.all %}
					{% for teammate in group.members.all %}
						<option name="{{ teammate.username }}">{{ teammate.username }}</option>
					{% endfor %}
				{% endfor %}

			</select>
		</div>


		<div class="select" >
			<select name="calc_project" id="calc_project" onchange="set_page(1);">
				<option name="all">All projects</option>
				{% for proj in user.profile.project_set.all %}
				<option name="{{ proj }}">{{ proj }}</option>
				{% endfor %}
			</select>
		</div>
		<div class="select" >
			<select name="calc_project" id="calc_type" onchange="set_page(1);">
				<option name="all">All</option>
			    	<option>Geometrical Optimisation</option>
			    	<option>Constrained Optimisation</option>
			    	<option>Conformer Search</option>
			    	<option>UV/Vis Spectrum Prediction</option>
			    	<option>NMR Spectrum Prediction</option>
			    	<option>Opt+Freq</option>
			    	<option>TS+Freq</option>
			</select>
		</div>

		<div id="calculations_list">
		
		</div>
		<br>
	{% else %}
		Please login to access the Sandbox
	{% endif %}

<br />
{% endblock %}

