{% extends 'frontend/base.html' %}

{% load static %}

{% block extrahead %}
	<title>CalcUS - Calculations</title>
	<link rel="stylesheet" href="{% static 'frontend/ChemDoodleWeb.css' %}" type="text/css">
	<script type="text/javascript" src="{% static 'frontend/ChemDoodleWeb.js' %}"></script>
	<link rel="stylesheet" href="{% static 'frontend/uis/jquery-ui-1.11.4.css' %}" type="text/css">
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>

	<script src="https://unpkg.com/masonry-layout@4.2.0/dist/masonry.pkgd.min.js"></script>
	<style>
		.new {
			box-sizing: border-box;
			border: 4px solid yellow;
			animation: blinker 1s linear infinite;
		}

		@keyframes blinker {
			50% {
				opacity: 0.7;
			}
		}

	</style>
	<script>
		let page = 1;
		let loading = false;
		
		$(document).ready(function(){
			refresh_list('add');
		});
		
		function see(o_id) {
			var calc_mode = document.getElementById("calc_mode");
			mode = calc_mode.options[calc_mode.selectedIndex].text;

			if (mode == "All orders") { return; }

			art = document.getElementById("order_" + o_id);
			$.ajax({
				data: {
					csrfmiddlewaretoken: ('{{csrf_token}}'),
				},
				method: "POST",
				url: '/see/' + o_id,
				success: function () {
					if (art.classList.contains("new")) {
						$("#order_" + o_id).removeClass("new");	
						badge = document.getElementById("unseen_calculations_badge");
						old_num = badge.textContent;
						new_num = parseInt(old_num)-1;
						if (new_num > 0) {
							badge.textContent = new_num;
						}
						else {
							$("#unseen_calculations_badge").remove();
						}
					}
					else {
						if (art.firstElementChild.classList.contains("has-background-success") || art.firstElementChild.classList.contains("has-background-danger") ) {
							$grid.masonry('remove', art).masonry();
						}
					}
				},
			    });

		}

		function refresh_list(mode) {
			var sel = document.getElementById("calc_project");
			opt = sel.options[sel.selectedIndex].text;

			var sel2 = document.getElementById("calc_user");
			user = sel2.options[sel2.selectedIndex].text;

			var sel3 = document.getElementById("calc_type");
			type = sel3.options[sel3.selectedIndex].text;

			var sel4 = document.getElementById("calc_status");
			status = sel4.options[sel4.selectedIndex].text;

			var sel5 = document.getElementById("calc_mode");
			sel_mode = sel5.options[sel5.selectedIndex].text;

			if (mode == 'new') { 
				page = 1; 
				$grid.masonry('remove', $grid.find('.grid-item'));
				msg = document.getElementById("tmp_msg");
				if (msg) { msg.remove() }
			}

			$.ajax({
				data: {
					csrfmiddlewaretoken: ('{{csrf_token}}'),
					project: opt,	
					page: page,
					user: user,
					type: type,
					status: status,
					mode: sel_mode,
				},
				method: "GET",
				url: '/list/',
				success: function (data, textStatus, xhr) {
					if (xhr.status == 200 && !data.includes("Page not found")) {
						let items = $(data);
						$grid.append(items).masonry('appended', items);	
						$grid.masonry();
   						$(window).bind('scroll', scroll_test);
					}
				},
			    });
		}
		
		function refresh_project_list() {
			var sel2 = document.getElementById("calc_user");
			user = sel2.options[sel2.selectedIndex].text;
			$.ajax({
				data: {
					csrfmiddlewaretoken: ('{{csrf_token}}'),
					user: user,
				},
				method: "POST",
				url: '/project_list/',
				success: function (data, textStatus, xhr) {
					if (xhr.status != 204) {
				    		$("#calc_project").html(data);
						refresh_list('new');
					}
				},
				error: function () {
				    $("#calc_project").html("");
					
				}
			    });


		}

		$(document).ready(function(){     
   			$(window).bind('scroll', scroll_test);
		});

		function scroll_test() {
			let page_bottom = $(".footer").offset().top;
			let user_bottom = $(window).scrollTop() + window.innerHeight; 

			if (page_bottom - user_bottom < 200) {
				if (!loading) {
					loading = true;
					$(window).unbind();
					page += 1;
					refresh_list('add');
					loading = false;
				}
			    }
		}
	</script>
{% endblock %}

{% block content %}
<div class="container">
	{% if user.is_authenticated %}
	<center>
		<div class="box">
			<div class="select" >
				<select name="calc_user" id="calc_user" onchange="refresh_project_list('new');">
					<option>{{ user.username }}</option>
					{% for teammate in user.profile.groups.members.all %}
						{% if teammate != user.profile %}
							<option name="{{ teammate.username }}">{{ teammate.username }}</option>
						{% endif %}
					{% endfor %}
					{% if user.profile.groups.PI != None %}
						<option name="{{ user.profile.groups.PI.username }}">{{ user.profile.groups.PI.username }}</option>
					{% endif %}
					{% for group in user.profile.researchgroup_PI.all %}
						{% for teammate in group.members.all %}
							<option name="{{ teammate.username }}">{{ teammate.username }}</option>
						{% endfor %}
					{% endfor %}

				</select>
			</div>


			<div class="select" >
				<select name="calc_project" id="calc_project" onchange="refresh_list('new');">
					<option name="all">All projects</option>
					{% for proj in user.profile.project_set.all %}
					<option name="{{ proj }}">{{ proj }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="select" >
				<select name="calc_type" id="calc_type" onchange="refresh_list('new');">
					<option name="all">All steps</option>
					{% for s in steps %}
					<option name="{{ s.name }}">{{ s.name }}</option>
					{% endfor %}

				</select>
			</div>
			<div class="select" >
				<select name="calc_status" id="calc_status" onchange="refresh_list('new');">
					<option name="all">All statuses</option>
					<option>Done</option>
					<option>Error</option>
					<option>Running</option>
					<option>Queued</option>
				</select>
			</div>
			<div class="select" >
				<select name="calc_mode" id="calc_mode" onchange="refresh_list('new');">
					<option>Workspace</option>
					<option>Unseen only</option>
					<option>All orders</option>
				</select>
			</div>

		</div>
		
		<div class="grid" id="calculations_list">

		</div>
	</center>
		<br>
	{% else %}
		Please login to access the Sandbox
	{% endif %}
	<script>
		var $grid = $('.grid').masonry({
			  itemSelector: '.grid-item',
			  fitWidth: true
		});
	</script>
<br />
{% endblock %}

