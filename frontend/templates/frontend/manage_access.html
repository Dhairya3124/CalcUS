{% extends 'frontend/base.html' %}

{% load i18n bulma_tags %}
{% load static %}

{% block extrahead %}
	<title>CalcUS - Manage Access</title>
	<script src="{% static 'frontend/jquery.min.js' %}"></script>
	<style>
		#content_container > .box {
			max-width: 30%;
			margin: 20px auto;
		}
	</style>
	<script>
		function connect_access() {
			password = document.getElementById("ssh_password").value;
			$.ajax({
				type: "POST",
				url: "/connect_access/",
				headers:{
					"X-CSRFToken": '{{ csrf_token }}',
				},
				data: {'access_id': {{ access.id }}, 'password': password}, 
				success: function()
				{
					var my_refresh = setInterval(function() {
						$.ajax({
							type: "POST",
							url: "/get_command_status/",
							data: {'access_id': {{ access.id }}}, 
							headers:{
								"X-CSRFToken": '{{ csrf_token }}',
							},

							success: function(data)
							{
								$("#test_msg").html(data);
								if (data != "Pending") {
									clearInterval(my_refresh);
									refresh_status();
								}
							}
						});
			 		}, 1000);

				}
			});

		}
		function disconnect_access() {
			$.ajax({
				type: "POST",
				url: "/disconnect_access/",
				headers:{
					"X-CSRFToken": '{{ csrf_token }}',
				},
				data: {'access_id': {{ access.id }}}, 
				success: function(data)
				{
					$("#test_msg").html("Access disconnected");
				}
			});

		}

		function refresh_status() {
			$.ajax({
				type: "POST",
				url: "/status_access/",
				headers:{
					"X-CSRFToken": '{{ csrf_token }}',
				},
				data: {'access_id': {{ access.id }}}, 
				success: function(data)
				{
					if(data.search("Connected") != -1) {
						$("#status_box").html(data);		
						$("#status_box").removeClass("has-background-danger");		
						$("#status_box").addClass("has-background-success");		
					}
					else {
						$("#status_box").html(data);		
						$("#status_box").addClass("has-background-danger");		
						$("#status_box").removeClass("has-background-success");		

					}
				}});
		}

		function delete_access() {
			var res = confirm("Delete access?");	
			if (res) {
				$.ajax({
					method: "GET",
					url: "/delete_access/{{ access.id }}",
					headers: {
						"X-CSRFToken": '{{ csrf_token }}',
					},
					success: function() {
						window.location.replace("/profile");
					}
				});
			}
			
		}

		$(document).ready(function() {
			refresh_status();
		});
	</script>
{% endblock %}
{% block content %}
{% csrf_token %}

<div class="box">
	<center>
		<table class="table">
			<tbody>
				<tr>
					<th>Cluster address</th>
					<td>{{ access.cluster_address }}</td>
				</tr>
				<tr>
					<th>Username</th>
					<td>{{ access.cluster_username }}</td>
				</tr>
				<tr>
					<th>CPU</th>
					<td>{{ access.pal }}</td>
				</tr>
				<tr>
					<th>Memory (MB)</th>
					<td>{{ access.memory }}</td>
				</tr>
			</tbody>
		</table>
	</center>
</div>
<div class="box">
	<center>
		<div>
			<label class="label">Status</label>
			<div class="box" id="status_box"></div>
		</div>
		<br />
		<div class="field">
			<label class="label">Password for Access</label>
			<div class="control">
				<input class="input" type="password" id="ssh_password" style="width: 100%;">
			</div>
		</div>

		<button class="button is-primary" id="connect_button" onclick="connect_access();">Connect to cluster</button>
		<button class="button is-danger" id="disconnect_button" onclick="disconnect_access();">Disconnect</button>
		<div id="test_msg">
		</div>
	</center>
</div>
<div class="box has-text-centered">
	<a class="button is-danger" onclick="delete_access();" id="delete_access_button" >Delete this access</a>
</div>


{% endblock content %}
