{% extends 'frontend/base.html' %}

{% load i18n bulma_tags %}

{% load static %}

{% block extrahead %}
	<link rel="stylesheet" href="{% static 'frontend/ChemDoodleWeb.css' %}" type="text/css">
	<script type="text/javascript" src="{% static 'frontend/ChemDoodleWeb.js' %}"></script>
	<link rel="stylesheet" href="{% static 'frontend/uis/jquery-ui-1.11.4.css' %}" type="text/css">
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<script type="text/javascript" src="{% static 'frontend/uis/ChemDoodleWeb-uis.js' %}"></script>
	<script>
	(function(ChemDoodle) {
		ChemDoodle.relabel = function(molecule){
	    		for(let i = 0, ii = molecule.atoms.length; i<ii; i++){
	    			molecule.atoms[i].altLabel = String(i+1);
	    		}
	  	};
	})(ChemDoodle);

	let constraint_num = 1;
	String.prototype.format = function() {
  		a = this;
  		for (k in arguments[1]) {
    			a = a.replace("{" + k + "}", arguments[0])
  		}
  		return a
	}
	</script>

	<script>
		function calc_selection_changed() {
			choice = document.getElementById("calc_type");
			constraint_div = document.getElementById("constraint_div");
			if(choice.value == "Constrained Optimisation") {
				constraint_div.style.display = "block";	
				editor.styles.atoms_displayLabels_3D = true;
			}
			else {
				constraint_div.style.display = "none";	
				editor.styles.atoms_displayLabels_3D = false;
			}
		}
		function constraint_type_selection_changed(id) {
			choice = document.getElementById("constraint_type_{0}".format(id, [0]));
			inp2 = document.getElementById("calc_constraint_{0}_2".format(id, [0]));
			inp3 = document.getElementById("calc_constraint_{0}_3".format(id, [0]));
			inp4 = document.getElementById("calc_constraint_{0}_4".format(id, [0]));
			if (choice.value == "Distance") {
				inp2.style.display = "block";	
				inp3.style.display = "none";	
				inp4.style.display = "none";	
			}
			else if (choice.value == "Angle") {
				inp2.style.display = "block";	
				inp3.style.display = "block";	
				inp4.style.display = "none";	
			}
			else {
				inp2.style.display = "block";	
				inp3.style.display = "block";	
				inp4.style.display = "block";	
			}
		}

		function constraint_mode_changed(id) {
			choice = document.getElementById("constraint_mode_{0}".format(id, [0]));
			div = document.getElementById("calc_scan_div_{0}".format(id, [0]));
			if (choice.value == "Freeze") {
				div.style.display = "none";	
			}
			else if (choice.value == "Scan") {
				div.style.display = "block";	
			}
		}

		function project_selection_changed() {
			choice = document.getElementById("calc_project");
			field = document.getElementById("new_project_name_field");
			if(choice.value == "New Project") {
				field.style.display = "block";	
			}
			else {
				field.style.display = "none";	
			}
		}

		function software_selection_changed() {
			choice = document.getElementById("calc_software");
			$("#software_specific_div").load("/software/" + choice.value);
		}

		function add_constraint() {
			constraint_num += 1;
			$("#constraint_list").append('<div class="control" id="constraint_1"> \
				<div class="columns"> \
					<div class="column"> \
						<div class="select"> \
							<select name="constraint_mode_{0}" id="constraint_mode_{1}" onchange="constraint_mode_changed({13})"> \
							<option>Freeze</option> \
							<option>Scan</option> \
							</select> \
						</div> \
					</div> \
					<div class="column"> \
						<div class="select"> \
				<select name="constraint_type_{2}" id="constraint_type_{3}" onchange="constraint_type_selection_changed({12});"> \
							<option>Distance</option> \
							<option>Angle</option> \
							<option>Dihedral</option> \
							</select> \
						</div> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{4}_1" id="calc_constraint_{5}_1"> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{6}_2" id="calc_constraint_{7}_2"> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{8}_3" id="calc_constraint_{9}_3" style="display: none;"> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{10}_4" id="calc_constraint_{11}_4" style="display: none;"> \
					</div> \
					<div class="column"> \
						<button type="button" class="button is-danger" onclick="$(this).parent().parent().parent().remove();">-</button> \
					</div> \
				</div> \
			</div> \
				<div style="display: none;" id="calc_scan_div_{14}"> \
				<div class="columns"> \
				<div class="column"> \
					From \
				<input class="input" type="text" width="5" name="calc_scan_{15}_1" id="calc_scan_{16}_1"> \
				</div> \
				<div class="column"> \
					To \
				<input class="input" type="text" width="5" name="calc_scan_{17}_2" id="calc_scan_{18}_2"> \
				</div> \
				<div class="column"> \
					# Steps \
				<input class="input" type="text" width="5" name="calc_scan_{19}_3" id="calc_scan_{20}_3"> \
				</div> \
			</div> \
			</div>'.format(constraint_num, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]));

		}
		
		function get_3D() {
		let mol = ChemDoodle.writeMOL(sketcher.getMolecule());

		$.ajax({
			method: "POST",	 	 
			url: "/gen_3D/",
			headers: {
				"X-CSRFToken": '{{ csrf_token }}',
			},

			data: {'mol': mol},
			success: function(data, textStatus, xhr) {
				let mol_read = ChemDoodle.readXYZ(data);
				ChemDoodle.relabel(mol_read);
				editor.loadMolecule(mol_read);	
			}
		});
		
		}
		$(document).ready(function () {
			software_selection_changed()
		});
	</script>
{% endblock %}

{% block content %}

{% csrf_token %}

<div class="columns">
	<div class="column is-half">
		{% if not ensemble and not structure %}
		<script>
		  	let sketcher = new ChemDoodle.SketcherCanvas('sketcher', 500, 300, {useServices:false, oneMolecule:false});
		  	sketcher.styles.atoms_useJMOLColors = true;
		  	sketcher.oneMolecule = false;
		  	sketcher.styles.bonds_clearOverlaps_2D = true;
		  	sketcher.styles.shapes_color = 'c10000';
		  	sketcher.repaint();
		</script>
		<button class="button" onclick="get_3D();">Generate 3D representation</button>
		{% endif %}
		<script>
		  	let editor = new ChemDoodle.EditorCanvas3D('editor', 500, 300, {useServices:false, oneMolecule:false});
		  	editor.styles.atoms_useJMOLColors = true;
		  	editor.oneMolecule = false;
			editor.styles.set3DRepresentation('Stick');
		  	editor.styles.shapes_color = 'c10000';
		  	editor.repaint();
		</script>

	</div>
	<div class="column">
		<form action="/submit_calculation/" method="post" id="calcform" enctype="multipart/form-data">

			{% if not ensemble and not structure %}
			<div class="field">
				<label class="label">Draw a structure or choose a file</label>
				<div class="control">
					<input type="file" name="file_structure">
				</div>
			</div>
			{% endif %}
			{% csrf_token %}

			<div class="columns">
				{% if not ensemble and not structure %}
				<div class="column">
						<div class="field">
							<label class="label">Molecule Name</label>
							<div class="control">
								<input class="input" name="calc_name" type="text" placeholder="My Molecule" required>
							</div>
						</div>
				</div>
				{% endif %}

				<div class="column is-narrow">
					<div class="field">
						<label class="label">Solvent</label>
						<div class="control" >
							<div class="select">
							  <select name="calc_solvent">
							    <option selected="selected">Vacuum</option>
							    <option>Acetone</option>
							    <option>Acetonitrile</option>
							    <option>Benzene</option>
							    <option>Dichloromethane</option>
							    <option>Chloroform</option>
							    <option>Carbon disulfide</option>
							    <option>Dimethylformamide</option>
							    <option>Dimethylsulfoxide</option>
							    <option>Diethyl ether</option>
							    <option>Methanol</option>
							    <option>n-Hexane</option>
							    <option>Tetrahydrofuran</option>
							    <option>Toluene</option>
							    <option>Water</option>
							  </select>
							</div>
						</div>
					</div>
				</div>

				<div class="column is-narrow">
					<div class="field">
						<label class="label">Charge</label>
						<div class="control" >
							<div class="select">
							  <select  name="calc_charge">
							    <option>+2</option>
							    <option>+1</option>
							    <option selected="selected">0</option>
							    <option>-1</option>
							    <option>-2</option>
							  </select>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="columns">
				<div class="column is-narrow">
					<div class="field">
						<label class="label">Project</label>
						<div class="control">
							<div class="select" >
							  <select name="calc_project" onchange="project_selection_changed()" id="calc_project">
								  {% for proj in profile.project_set.all %}
								  <option name="{{ proj }}">{{ proj }}</option>
								  {% endfor %}
								  <option name="new_project">New Project</option>
							  </select>
							</div>
						</div>
					</div>

				</div>
				<div class="column">
					<div class="field" style="display: none;" id="new_project_name_field">
						<label class="label">Name of new project</label>
						<div class="control">
							<input class="input" name="new_project_name" type="text" placeholder="My Project">
						</div>
					</div>
				</div>

			</div>

			<div class="field">
				<label class="label">Software</label>
				<div class="control" >
					<div class="select">
						<select name="calc_software" id="calc_software" onchange="software_selection_changed();">
							<option>xtb</option>
							<option>ORCA</option>
							<option>Gaussian</option>
					  	</select>
					</div>
				</div>
			</div>

			<div id="software_specific_div">
			</div>

			<div class="field">
				<label class="label">Resource</label>
				<div class="control" >
					<div class="select">
					<select name="calc_ressource">
						{% if profile.group or profile.is_PI %}
							<option>Local</option>
						{% endif %}
					    	{% for access in profile.accesses %}
							<option>{{ access.cluster_address }}</option>
						{% endfor %}
					  </select>
					</div>
				</div>
			</div>

			<div class="field">
				<div class="control">
					<button class="button is-primary" id="submit_button">Submit</button>
				</div>
			</div>
		</form>
	</div>
</div>
<script>
	$('#calcform').submit(function(){
		$('<input />').attr('type', 'hidden')
			.attr('name', "constraint_num")
			.attr('value', constraint_num)
			.appendTo(this);

		{% if ensemble %}
		$('<input />').attr('type', 'hidden')
			.attr('name', "starting_ensemble")
			.attr('value', {{ ensemble.id }})
			.appendTo(this);

		{% endif %}

		{% if structure %}
		$('<input />').attr('type', 'hidden')
			.attr('name', "starting_struct")
			.attr('value', {{ structure.id }})
			.appendTo(this);

		{% endif %}
		if (editor.molecules.length > 0) {
			let mol2 = ChemDoodle.writeMOL(editor.getMolecule());

			$('<input />').attr('type', 'hidden')
				.attr('name', "structure").val(mol2).appendTo("#calcform");
		}

		if (sketcher.molecules.length > 0) {
			let mol = ChemDoodle.writeMOL(sketcher.getMolecule());

			$('<input />').attr('type', 'hidden')
				.attr('name', "structureB").val(mol).appendTo("#calcform");
		}

		return true;
	}); 

$( document ).ready(function() {
	project_selection_changed();
});
{% if ensemble %}
	$("#calc_project").val("{{ ensemble.parent_molecule.project.name }}");
	$.ajax({
		method: "POST",	 	 
		url: "/get_structure/",
		headers: {
			"X-CSRFToken": '{{ csrf_token }}',
		},

		data: {'id': {{ ensemble.id }}, 'num': 1},
		success: function(data, textStatus, xhr) {
			let mol_read = ChemDoodle.readXYZ(data);
			ChemDoodle.relabel(mol_read);
			editor.loadMolecule(mol_read);	
		}
	});

{% endif %}

{% if structure %}
	let mol_read = ChemDoodle.readXYZ(`{{ structure.xyz_structure }}`);
	ChemDoodle.relabel(mol_read);
	editor.loadMolecule(mol_read);	
{% endif %}
</script>

{% endblock content %}
