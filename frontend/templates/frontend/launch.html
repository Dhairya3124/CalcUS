{% extends 'frontend/base.html' %}

{% load i18n bulma_tags %}

{% load static %}

{% block extrahead %}
	<link rel="stylesheet" href="{% static 'frontend/ChemDoodleWeb.css' %}" type="text/css">
	<script type="text/javascript" src="{% static 'frontend/ChemDoodleWeb.js' %}"></script>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<link rel="stylesheet" href="{% static 'frontend/uis/jquery-ui-1.11.4.css' %}" type="text/css">
	<script type="text/javascript" src="{% static 'frontend/uis/ChemDoodleWeb-uis.js' %}"></script>

	<script>
	(function(ChemDoodle) {
		ChemDoodle.relabel = function(molecule){
	    		for(let i = 0, ii = molecule.atoms.length; i<ii; i++){
	    			molecule.atoms[i].altLabel = String(i+1);
	    		}
	  	};
	})(ChemDoodle);

	let constraint_num = 1;
	String.prototype.format = function() {
  		a = this;
		for (i=0; i < 30; i++) {
    			a = a.replace("{}", arguments[0])
		}
  		return a
	}
	</script>
	<script>
		{% if ensemble %}
			function filter_changed() {
				choice = document.getElementById("calc_filter");
				value_input = document.getElementById("calc_filter_value");
				param_input = document.getElementById("calc_filter_params");
				label = document.getElementById("filter_label");
				if(choice.value == "None") {
					value_input.style.display = "none";
					param_input.style.display = "none";
				}
				else if(choice.value == "By Boltzmann Weight") {
					value_input.style.display = "block";
					param_input.style.display = "block";
					label.innerHTML = "Higher than";
				}
				else if(choice.value == "By Relative Energy") {
					value_input.style.display = "block";
					param_input.style.display = "block";
					label.innerHTML = "Lower than (kJ/mol)";
				}
			}

		{% endif %}

		function calc_selection_changed() {
			choice = document.getElementById("calc_type");
			constraint_div = document.getElementById("constraint_div");
			if(choice.value == "Constrained Optimisation") {
				constraint_div.style.display = "block";	
				editor.styles.atoms_displayLabels_3D = true;
			}
			else {
				constraint_div.style.display = "none";	
				editor.styles.atoms_displayLabels_3D = false;
			}
			set_visibility_name();
		}
		
		function set_visibility_name() {
			choice = document.getElementById("calc_type");
			field = document.getElementById("calc_name_field");
			if(ensemble == true) {
				if(choice.value == "Geometrical Optimisation" ||  choice.value == "Constrained Optimisation" || choice.value == "Conformational Search" ||  choice.value == "TS Optimisation") {
					field.style.display = "block";
				}
				else {
					field.style.display = "none";
				}
			}
			else {
				field.style.display = "block";

			}

		}

		function constraint_type_selection_changed(id) {
			choice = document.getElementById("constraint_type_{}".format(id));
			inp2 = document.getElementById("calc_constraint_{}_2".format(id));
			inp3 = document.getElementById("calc_constraint_{}_3".format(id));
			inp4 = document.getElementById("calc_constraint_{}_4".format(id));
			if (choice.value == "Distance") {
				inp2.style.display = "block";	
				inp3.style.display = "none";	
				inp4.style.display = "none";	
			}
			else if (choice.value == "Angle") {
				inp2.style.display = "block";	
				inp3.style.display = "block";	
				inp4.style.display = "none";	
			}
			else {
				inp2.style.display = "block";	
				inp3.style.display = "block";	
				inp4.style.display = "block";	
			}
		}

		function constraint_mode_changed(id) {
			choice = document.getElementById("constraint_mode_{}".format(id));
			div = document.getElementById("calc_scan_div_{}".format(id));
			if (choice.value == "Freeze") {
				div.style.display = "none";	
			}
			else if (choice.value == "Scan") {
				div.style.display = "block";	
				check_scan_from();
			}
		}

		function check_scan_from() {
			software = document.getElementById("calc_software");
			if (software.value == "Gaussian") {
				to_hide = $(".scan_from");
				for (i=0; i < to_hide.length; i++) {
					to_hide[i].style.display = "none";
				}
			}
			else {
				to_hide = $(".scan_from");
				for (i=0; i < to_hide.length; i++) {
					to_hide[i].style.display = "block";
				}
			}
		}

		function project_selection_changed() {
			choice = document.getElementById("calc_project");
			field = document.getElementById("new_project_name_field");
			if(choice.value == "New Project") {
				field.style.display = "block";
			}
			else {
				field.style.display = "none";	
			}
		}

		function software_selection_changed() {
			choice = document.getElementById("calc_software");
			$("#software_specific_div").load("/software/" + choice.value);
			check_scan_from();
		}

		function add_constraint() {
			constraint_num += 1;
			$("#constraint_list").append(`
			<div class="control" id="constraint_1"> \
				<div class="columns"> \
					<div class="column"> \
						<div class="select"> \
							<select name="constraint_mode_{}" id="constraint_mode_{}" onchange="constraint_mode_changed({})"> \
							<option>Freeze</option> \
							<option>Scan</option> \
							</select> \
						</div> \
					</div> \
					<div class="column"> \
						<div class="select"> \
				<select name="constraint_type_{}" id="constraint_type_{}" onchange="constraint_type_selection_changed({});"> \
							<option>Distance</option> \
							<option>Angle</option> \
							<option>Dihedral</option> \
							</select> \
						</div> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{}_1" id="calc_constraint_{}_1"> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{}_2" id="calc_constraint_{}_2"> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{}_3" id="calc_constraint_{}_3" style="display: none;"> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{}_4" id="calc_constraint_{}_4" style="display: none;"> \
					</div> \
					<div class="column"> \
				<button type="button" class="button is-danger" onclick="$('#calc_scan_div_{}').remove(); $(this).parent().parent().parent().remove();">-</button> \
					</div> \
				</div> \
			</div> \
				<div style="display: none;" id="calc_scan_div_{}"> \
				<div class="columns"> \
				<div class="column"> \
					From (Å)\
				<input class="input scan_from" type="text" width="5" name="calc_scan_{}_1" id="calc_scan_{}_1"> \
				</div> \
				<div class="column"> \
					To (Å) \
				<input class="input" type="text" width="5" name="calc_scan_{}_2" id="calc_scan_{}_2"> \
				</div> \
				<div class="column"> \
					# Steps \
				<input class="input" type="text" width="5" name="calc_scan_{}_3" id="calc_scan_{}_3"> \
				</div> \
			</div> \
			</div>`.format(constraint_num));

		}
		
		function get_3D() {
			let mol = ChemDoodle.writeMOL(sketcher.getMolecule());

			$.ajax({
				method: "POST",	 	 
				url: "/gen_3D/",
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},

				data: {'mol': mol},
				statusCode: {
					404: function(data) {
						$("#3d_msg").html("Error while generating structure");
					},
					200: function(data) {
						$("#3d_msg").html("");
						let mol_read = ChemDoodle.readXYZ(data);
						ChemDoodle.relabel(mol_read);
						editor.loadMolecule(mol_read);	
					}
				}
			});
		}
		
		function add_file_name() {
			path = $("#file_structure").val();
			file_name = path.replace('C:\\fakepath\\', '').split('.')[0];
			$("#calc_name").val(file_name);
		}

		{% if ensemble %}
		let ensemble = true;
		{% else %}
		let ensemble = false;
		{% endif %}
		$(document).ready(function () {
			software_selection_changed();
			{% if ensemble %}
			filter_changed();
			{% endif %}
		});
	</script>
{% endblock %}

{% block content %}

{% csrf_token %}

	<div class="columns is-desktop">
		<div class="column">
			{% if not ensemble and not structure %}
			<script>
				let sketcher = new ChemDoodle.SketcherCanvas('sketcher', 400, 300, {useServices:false, oneMolecule:false});
				sketcher.styles.atoms_usePYMOLColors = true;
				sketcher.oneMolecule = false;
				sketcher.styles.bonds_clearOverlaps_2D = true;
				sketcher.styles.shapes_color = 'c10000';
				sketcher.repaint();
			</script>
			<br />
			<button class="button" onclick="get_3D();">Generate 3D representation</button>
			{% endif %}

			<script>
				let editor = new ChemDoodle.EditorCanvas3D('editor', 400, 300, {useServices:false, oneMolecule:false});
				editor.styles.atoms_usePYMOLColors = true;
				editor.oneMolecule = false;
				editor.styles.set3DRepresentation('Stick');
				editor.styles.shapes_color = 'c10000';
				editor.repaint();
			</script>
			<div id="3d_msg">
			</div>

		</div>
		<div class="column">
			<form action="/submit_calculation/" method="post" id="calcform" enctype="multipart/form-data">

				{% if not ensemble and not structure %}
				<div class="field">
					<label class="label">Draw a structure or choose a file</label>
					<div class="control">
						<input type="file" name="file_structure" id="file_structure" onchange="add_file_name()">
					</div>
				</div>

				{% endif %}
				{% csrf_token %}

				<div class="columns">
					<div class="column">
						<div class="field" id="calc_name_field">
							<label class="label">Name</label>
							<div class="control">
								<input class="input" name="calc_name" id="calc_name" type="text">
							</div>
						</div>
					</div>

					<div class="column is-narrow">
						<div class="field">
							<label class="label">Solvent</label>
							<div class="control" >
								<div class="select">
								  <select name="calc_solvent" id="calc_solvent">
								    <option selected="selected">Vacuum</option>
								    <option>Acetone</option>
								    <option>Acetonitrile</option>
								    <option>Benzene</option>
								    <option>Dichloromethane</option>
								    <option>Chloroform</option>
								    <option>Carbon disulfide</option>
								    <option>Dimethylformamide</option>
								    <option>Dimethylsulfoxide</option>
								    <option>Diethyl ether</option>
								    <option>Methanol</option>
								    <option>n-Hexane</option>
								    <option>Tetrahydrofuran</option>
								    <option>Toluene</option>
								    <option>Water</option>
								  </select>
								</div>
							</div>
						</div>
					</div>

					<div class="column is-narrow">
						<div class="field">
							<label class="label">Charge</label>
							<div class="control" >
								<div class="select">
								  <select name="calc_charge" id="calc_charge">
								    <option>+2</option>
								    <option>+1</option>
								    <option selected="selected">0</option>
								    <option>-1</option>
								    <option>-2</option>
								  </select>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="columns">
					<div class="column is-narrow">
						<div class="field">
							<label class="label">Project</label>
							<div class="control">
								<div class="select" >
								  <select name="calc_project" onchange="project_selection_changed()" id="calc_project">
									  {% for proj in profile.project_set.all %}
									  <option name="{{ proj }}">{{ proj }}</option>
									  {% endfor %}
									  <option name="new_project">New Project</option>
								  </select>
								</div>
							</div>
						</div>

					</div>
					<div class="column">
						<div class="field" style="display: none;" id="new_project_name_field">
							<label class="label">Name of new project</label>
							<div class="control">
								<input class="input" name="new_project_name" type="text" placeholder="My Project">
							</div>
						</div>
					</div>

				</div>

				<div class="field">
					<label class="label">Software</label>
					<div class="control" >
						<div class="select">
							<select name="calc_software" id="calc_software" onchange="software_selection_changed();">
								<option>xtb</option>
								<option>ORCA</option>
								<option>Gaussian</option>
							</select>
						</div>
					</div>
				</div>

				<div id="software_specific_div">
				</div>

				<div class="field">
					<label class="label">Resource</label>
					<div class="control" >
						<div class="select">
						<select name="calc_ressource">
							{% if profile.group or profile.is_PI %}
								<option>Local</option>
							{% endif %}
							{% for access in profile.accesses %}
								<option>{{ access.cluster_address }}</option>
							{% endfor %}
						  </select>
						</div>
					</div>
				</div>

				{% if ensemble %}
					<div class="columns">
						<div class="column">
							<div class="field">
								<label class="label">Filter</label>
								<div class="control" >
									<div class="select">
									<select name="calc_filter" onchange="filter_changed();" id="calc_filter">
										<option>None</option>
										<option>By Relative Energy</option>
										<option>By Boltzmann Weight</option>
									  </select>
									</div>
								</div>
							</div>
						</div>
						<div class="column">
							<div class="field" style="display: none;" id="calc_filter_value">
								<label class="label" id="filter_label">Higher than</label>
								<div class="control">
									<input class="input" name="filter_value" type="text" id="filter_value_input">
								</div>
							</div>
						</div>
						<div class="column">
							<div class="field" id="calc_filter_params">
								<label class="label">Parameters</label>
								<div class="control" >
									<div class="select">
									<select name="filter_parameters">
										{% for p in ensemble.unique_parameters %}
											<option value="{{ p.id }}">{{ p }}</option>
										{% endfor %}
									  </select>
									</div>
								</div>
							</div>
						</div>

					</div>

				{% endif %}

				<div class="field">
					<div class="control">
						<button class="button is-primary" id="submit_button">Submit</button>
					</div>
				</div>
			</form>
		</div>
	</div>
	<script>
		$('#calcform').submit(function(){
			$('<input />').attr('type', 'hidden')
				.attr('name', "constraint_num")
				.attr('value', constraint_num)
				.appendTo(this);

			{% if ensemble %}
			$('<input />').attr('type', 'hidden')
				.attr('name', "starting_ensemble")
				.attr('value', {{ ensemble.id }})
				.appendTo(this);
			{% endif %}

			{% if structure %}
			$('<input />').attr('type', 'hidden')
				.attr('name', "starting_struct")
				.attr('value', {{ structure.id }})
				.appendTo(this);
			{% endif %}

			if (editor.molecules.length > 0) {
				let mol2 = ChemDoodle.writeMOL(editor.getMolecule());

				$('<input />').attr('type', 'hidden')
					.attr('name', "structure").val(mol2).appendTo("#calcform");
			}

			if (sketcher.molecules.length > 0) {
				let mol = ChemDoodle.writeMOL(sketcher.getMolecule());

				$('<input />').attr('type', 'hidden')
					.attr('name', "structureB").val(mol).appendTo("#calcform");
			}

			return true;
		}); 

	$( document ).ready(function() {
		project_selection_changed();
	});
	{% if ensemble %}
		$("#calc_project").val("{{ ensemble.parent_molecule.project.name }}");
		$.ajax({
			method: "POST",	 	 
			url: "/get_structure/",
			headers: {
				"X-CSRFToken": '{{ csrf_token }}',
			},

			data: {'id': {{ ensemble.id }}, 'num': 1},
			success: function(data, textStatus, xhr) {
				let mol_read = ChemDoodle.readXYZ(data);
				ChemDoodle.relabel(mol_read);
				editor.loadMolecule(mol_read);	
			}
		});

	{% endif %}

	{% if structure %}
		$("#calc_project").val("{{ structure.parent_ensemble.parent_molecule.project.name }}");
		let mol_read = ChemDoodle.readXYZ(`{{ structure.xyz_structure }}`);
		ChemDoodle.relabel(mol_read);
		editor.loadMolecule(mol_read);	
	{% endif %}
	</script>
{% endblock content %}
