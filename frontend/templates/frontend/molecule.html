{% extends 'frontend/base.html' %}

{% load static %}

{% block extrahead %}
	<link rel="stylesheet" href="{% static 'frontend/ChemDoodleWeb.css' %}" type="text/css">
	<script type="text/javascript" src="{% static 'frontend/ChemDoodleWeb.js' %}"></script>
	<link rel="stylesheet" href="{% static 'frontend/uis/jquery-ui-1.11.4.css' %}" type="text/css">
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>

	<script src="https://unpkg.com/masonry-layout@4.2.0/dist/masonry.pkgd.min.js"></script>
	<script type="text/javascript" src="{% static 'frontend/uis/ChemDoodleWeb-uis.js' %}"></script>

{% endblock %}

{% block content %}
	<script>
		function selectText(node) {
		    	node = document.getElementById(node);

		    	if (document.body.createTextRange) {
				const range = document.body.createTextRange();
				range.moveToElementText(node);
				range.select();
		    	} else if (window.getSelection) {
				const selection = window.getSelection();
				const range = document.createRange();
				range.selectNodeContents(node);
				selection.removeAllRanges();
				selection.addRange(range);
			} else {
				console.warn("Could not select text in node: Unsupported browser.");
			}
		}
		function edit_field(e_id) {
			el = document.getElementById("e_name_" + e_id);
			if (el.getAttribute("contentEditable") == "true") {
				el.setAttribute("contentEditable", "false");
				$("#icon_" + e_id).removeClass("fa-check");
				$("#icon_" + e_id).addClass("fa-edit");
				name = el.textContent;
				$.ajax({
					method: "POST",	 	 
					url: "/rename_ensemble/",
					headers: {
						"X-CSRFToken": '{{ csrf_token }}',
					},
					data: {'id': e_id, 'new_name': name}
				});

			}
			else {
				el.setAttribute("contentEditable", "true");
				$("#icon_" + e_id).removeClass("fa-edit");
				$("#icon_" + e_id).addClass("fa-check");
				selectText('e_name_' + e_id);
				$('[contenteditable=true]').on('keypress', function(e) {
					if (e.keyCode == 13) {
						e.preventDefault();
						edit_field(e_id);
					}
				});

			}
			
		}

		let num = 1;
		let conf_number = 1;
		var curr_p = 0;

		$.ajaxSetup({ cache: false }); 
		$(document).ready(function(){
			var my_refresh = setInterval(function() {
				$.ajax({
					method: "POST",	 	 
					url: "/get_structure/",
					headers: {
						"X-CSRFToken": '{{ csrf_token }}',
					},
					data: {'id': {{ molecule.ensemble_set.all.0.id }}, 'num': 1},
					success: function(data, textStatus, xhr) {
						if (xhr.status != 204) {
							let mol = ChemDoodle.readXYZ(data);

							
							clearInterval(my_refresh);
							editor.loadMolecule(mol);

						}
					}
				});
			 }, 1000);
		});

	</script>

<div class="container">
	<nav class="breadcrumb" aria-label="breadcrumbs">
	 	<ul>
	    		<li><a href="/projects/">Projects</a></li>
			<li><a href="/projects/{{ molecule.project.author }}">{{ molecule.project.author }}</a></li>
			<li><a href="/projects/{{ molecule.project.author }}/{{ molecule.project }}">{{ molecule.project }}</a></li>
			<li class="is-active"><a aria-current="page" href="#">{{ molecule.name }}</a></li>
	  	</ul>
	</nav>
	<div class="box">
		<center>
			<h3 class="title is-3">Preview of {{ molecule.name }}</h3>
		</center>
		<div class="columns">
			<div class="column is-narrow">
				<script>
					let editor = new ChemDoodle.EditorCanvas3D('editor', 400, 400, {useServices: false});
					editor.styles.set3DRepresentation('Stick');
					editor.styles.backgroundColor = '#FFFFFF';
					editor.oneMolecule = false;
				</script>
			</div>
			<div class="column">
				<br />
				<center>
				<table class="table">
					<tr>
						<th>Ensemble</th>
						<th>Unique methods</th>
						<th>Unique calculations</th>
					</tr>
				{% for e in molecule.ensemble_set.all %}
					<tr>
						<td>{{ e.name }}</td>
						<td>
							{% for p in e.unique_parameters %}
								{{ p }} <br />
							{% endfor %}
						</td>
						<td>
							{% for c in e.unique_calculations %}
								{{ c }} <br />
							{% endfor %}
						</td>

					</tr>

				{% endfor %}
				</table>
				</center>
			</div>
		</div>

	</div>
	
	<center>
		<div id="ensembles_list">
			<div class="grid">
				{% if ensembles %}
					{% for e in ensembles %}
							<article class="message grid-item is-info">
								<div class="message-header">
<p id="e_name_{{ e.id }}">{{ e.name }}</p>
							<p onclick="edit_field({{ e.idÂ }});"><i class="fas fa-edit" id="icon_{{ e.id}}"></i></p>

								</div>
								<a href="/ensemble/{{ e.id}}">
									<div class="message-body" style="height: 80%;">
										<strong>Ensemble</strong>
										<br />
									{{ e.structure_set.count }} Structure(s)	
									</div>
								</a>
							</article>
					{% endfor %}
				{% else %}
					No ensemble
				{% endif %}
			</div>
		</div>
	</center>
{% endblock %}

