{% extends 'frontend/base.html' %}

{% load i18n bulma_tags %}

{% load static %}

{% block extrahead %}
	<link rel="stylesheet" href="{% static 'frontend/ChemDoodleWeb.css' %}" type="text/css">
	<script type="text/javascript" src="{% static 'frontend/ChemDoodleWeb.js' %}"></script>
	<link rel="stylesheet" href="{% static 'frontend/uis/jquery-ui-1.11.4.css' %}" type="text/css">
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<script type="text/javascript" src="{% static 'frontend/uis/ChemDoodleWeb-uis.js' %}"></script>

	<script>
		let num = 1;
		let conf_number = 1;

		$.ajaxSetup({ cache: false }); 
		$(document).ready(function(){
			var my_refresh = setInterval(function() {
				$.ajax({
					method: "POST",	 	 
					url: "/get_structure/",
					data: {'id': window.location.pathname {% if calculation.type == 1 %}, 'num' : num {% endif %}},
					success: function(data, textStatus, xhr) {
						if (xhr.status != 204) {
							let mol = ChemDoodle.readMOL(data, 1);

							editor.loadMolecule(mol);
							$("#calc_title").removeClass("has-background-warning");
							$("#calc_title").addClass("has-background-success");
						
							conf_number = {{ calculation.result_set.count }};
							clearInterval(my_refresh);
						}

					}
			  
				});
			 }, 1000);
		});

		function refresh() {
			$.ajax({
				method: "POST",	 	 
				url: "/get_structure/",
				data: {'id': window.location.pathname {% if calculation.type == 1 %}, 'num' : num {% endif %}},
				success: function(data, textStatus, xhr) {
					if (xhr.status != 204) {
						let mol = ChemDoodle.readMOL(data, 1);

						editor.loadMolecule(mol);
					}

				}
		  
			});

		}
		function increase_conf() {
			if(num < conf_number) {
				document.getElementById('conf_' + num).classList.remove("has-background-success");
				num = num + 1;
				document.getElementById('conf_' + num).classList.add("has-background-success");
				refresh();
			}

		}

		function decrease_conf() {
			if(num > 1) {
				document.getElementById('conf_' + num).classList.remove("has-background-success");
				num = num - 1;
				document.getElementById('conf_' + num).classList.add("has-background-success");
				refresh();
			}
		}
	</script>

{% endblock %}

{% block content %}

{% csrf_token %}

<div class="box ">
		<div class="box is-rounded {% if calculation.status == 1 %} has-background-warning {% elif calculation.status == 2 %} has-background-success {% elif calculation.status == 3 %} has-background-danger{% endif %}" id="calc_title">
	<center>
			<h3 class="title is-3 ">{{ calculation.name }}</h3>
			<h5 class="subtitle is-5">{{ calculation.date }}</h5>
	</center>
	</div>

	{% if calculation.type == 0 %}
	<strong>Geometrical Optimisation</strong>

	<div>
		<script>
			let editor = new ChemDoodle.EditorCanvas3D('editor', 400, 400, {});
			editor.styles.set3DRepresentation('Stick');
			editor.styles.backgroundColor = '#FFFFFF';
		</script>
		<br />
		<button class="button" onclick="window.location.href='/download_structure/{{ calculation.id }}'">Download structure in .mol</button>
	</div>
	Energy: {{ calculation.result_set.all.0.energy }}

	{% elif calculation.type == 1 %}

	<strong>Conformer Search</strong>

	<div class="columns">
		<div class="column">
			<script>
				let editor = new ChemDoodle.EditorCanvas3D('editor', 400, 400, {});
				editor.styles.set3DRepresentation('Stick');
				editor.styles.backgroundColor = '#FFFFFF';
			</script>
			<br />
			<button class="button" onclick="decrease_conf()">Previous Conformer</button>
			<button class="button" onclick="increase_conf()">Next Conformer</button>
			<br />
			<button class="button" onclick="window.location.href='/download_structure/{{ calculation.id }}'">Download structures in .mol</button>
		</div>
		<div class="column">
			<table class="table">
				<thead>
					<tr>
						<th>#</th>
						<th>Energy (Ha)</th>
						<th>Relative energy (kJ/mol)</th>
						<th>Boltzmann Weight at 298K</th>
					</tr>
				</thead>
				<tbody>
				{% for res in calculation.result_set.all %}
				<tr id="conf_{{ res.number }}" {% if res.number == 1 %} class="has-background-success" {% endif %}>
						<th>{{ res.number }}</th>
						<th>{{ res.energy }}</th>
						<th>{{ res.rel_energy|floatformat:1 }}</th>
						<th>{{ res.boltzmann_weight|floatformat:2 }}</th>
					</tr>
				{% endfor %}
				</tbody>
			</table>
		</div>
	</div>


	{% endif %}
</div>

{% endblock content %}
